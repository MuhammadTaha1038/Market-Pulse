<div class="p-6 space-y-4">
  
  <!-- Toast Messages -->
  <p-toast></p-toast>

  <!-- Statistics Banner -->
  <div *ngIf="sessionId" class="flex flex-wrap items-center gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-center gap-2">
      <i class="pi pi-file text-blue-600"></i>
      <span class="text-sm font-medium text-gray-700">File:</span>
      <span class="text-sm text-gray-900">{{ filename }}</span>
    </div>
    <div class="h-4 border-l border-blue-300"></div>
    <div *ngFor="let key of ['total_rows', 'valid_rows', 'deleted_rows', 'rules_applied_count'] | slice:0:4" 
         class="flex items-center gap-2">
      <p-tag 
        [value]="formatKey(key) + ': ' + (statistics[key] || 0)" 
        [severity]="getSeverity(key)">
      </p-tag>
    </div>
  </div>

  <!-- Top Toolbar -->
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex flex-wrap items-center gap-2">
      <input
        type="text"
        pInputText
        [(ngModel)]="searchText"
        placeholder="Search in table"
        class="p-inputtext-sm w-64"
      />
      
      <!-- Delete Selected Button -->
      <button 
        pButton 
        label="Delete Selected" 
        icon="pi pi-trash" 
        class="p-button-sm p-button-danger p-button-outlined"
        [disabled]="selectedRows.length === 0 || isProcessing"
        (click)="deleteSelectedRows()">
      </button>
      
      <!-- Run Rules with Dropdown -->
      <div class="flex items-center gap-2">
        <p-multiSelect
          [(ngModel)]="selectedRules"
          [options]="availableRules"
          optionLabel="name"
          placeholder="Select Rules"
          [filter]="true"
          [showHeader]="false"
          class="w-64"
          [disabled]="!sessionId || isProcessing"
        ></p-multiSelect>
        <button 
          pButton 
          label="Apply Rules" 
          icon="pi pi-cog" 
          class="p-button-sm p-button-outlined"
          [disabled]="selectedRules.length === 0 || isProcessing"
          (click)="applySelectedRules()">
        </button>
      </div>
      
      <!-- Filters Button (Presets) -->
      <button 
        pButton 
        label="Filters" 
        icon="pi pi-filter" 
        class="p-button-sm p-button-outlined" 
        (click)="openFilterDialog()">
      </button>
      
      <!-- Import Button -->
      <button 
        pButton 
        label="Import via Excel" 
        icon="pi pi-upload" 
        class="p-button-sm p-button-outlined"
        [disabled]="isUploading"
        (click)="openImportDialog()">
      </button>
      
      <!-- Clear/Reset Button -->
      <button 
        pButton 
        label="Clear Data" 
        icon="pi pi-times" 
        class="p-button-sm p-button-outlined p-button-danger"
        [disabled]="colors.length === 0"
        (click)="resetSession()"
        pTooltip="Clear all data and start fresh">
      </button>
    </div>

    <div class="flex items-center gap-3">
      <div class="text-sm text-gray-600">Total Count: <strong>{{ colors.length }}</strong></div>
      <button
        pButton
        label="Run Automation"
        icon="pi pi-play"
        class="p-button-sm p-button-rounded"
        style="background-color:white;color:#0b0b14;border-color:#d1d5db"
        [disabled]="colors.length === 0 || isSaving || isUploading"
        (click)="runAutomation()"
      >
        <i *ngIf="isSaving" class="pi pi-spin pi-spinner mr-2"></i>
      </button>
    </div>
  </div>

  <!-- Loading Spinner Overlay -->
  <div *ngIf="isProcessing || isUploading" class="flex items-center justify-center p-8">
    <p-progressSpinner></p-progressSpinner>
    <span class="ml-3 text-gray-600">{{ isUploading ? 'Uploading...' : 'Processing...' }}</span>
  </div>

  <!-- PrimeNG Table -->
  <p-table
    [value]="colors"
    [paginator]="true"
    [rows]="10"
    responsiveLayout="scroll"
    [rowsPerPageOptions]="[5,10,20,50]"
    class="shadow-md rounded-xl overflow-hidden"
    [(selection)]="selectedRows"
    dataKey="messageId"
    [loading]="isUploading || isProcessing"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th>#</th>
        <th *ngFor="let col of columns">{{ col.header }}</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row let-i="rowIndex">
      <tr [pSelectableRow]="row">
        <td>
          <p-tableCheckbox [value]="row"></p-tableCheckbox>
        </td>
        <td>{{ i + 1 }}</td>
        <td *ngFor="let col of columns">{{ row[col.field] }}</td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="columns.length + 2" class="text-center">
          <div class="py-8 text-gray-500">
            <i class="pi pi-inbox text-4xl mb-3"></i>
            <p>No data available. Import an Excel file to get started.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- File Import Dialog -->
  <p-dialog
    header="Import Color File"
    [(visible)]="showImportDialog"
    [modal]="true"
    [style]="{ width: '400px' }"
    [closable]="false"
  >
    <div class="flex flex-col items-center justify-center text-center space-y-4 py-6">
      <i class="pi pi-upload text-4xl text-gray-400"></i>
      <p class="text-gray-600 text-sm">Drop your CSV or Excel file here to import color data.</p>

      <p-fileUpload
        mode="basic"
        name="colorFile"
        accept=".csv,.xlsx"
        chooseLabel="Select File"
        (onSelect)="onUpload($event)"
      ></p-fileUpload>

      <button
        pButton
        label="Cancel"
        class="p-button-outlined p-button-sm"
        (click)="onCancelUpload()"
      ></button>
    </div>
  </p-dialog>

  <!-- Filter Dialog with Presets -->
  <p-dialog
    header="Filter"
    [(visible)]="showFilterDialog"
    [modal]="true"
    [style]="{ width: '600px' }"
    [closable]="true"
  >
    <div class="space-y-4">
      <div class="flex items-center gap-3">
        <label class="text-sm font-medium text-gray-700">Select Preset:</label>
        <p-autocomplete
          [(ngModel)]="selectedPreset"
          [suggestions]="filteredPresets"
          (completeMethod)="searchPreset($event)"
          field="name"
          [forceSelection]="true"
          placeholder="Choose a saved filter preset"
          [dropdown]="true"
          class="flex-1"
        >
          <ng-template let-preset pTemplate="item">
            <div>{{ preset.name }}</div>
          </ng-template>
        </p-autocomplete>
      </div>

      <div class="flex justify-between items-center pt-4 border-t">
        <button
          pButton
          label="Remove all filters"
          class="p-button-text p-button-sm text-gray-600"
          (click)="removeAllFilters()"
        ></button>
        <button
          pButton
          label="Apply Filters"
          class="p-button-sm"
          [disabled]="!selectedPreset"
          (click)="applyPreset()"
        ></button>
      </div>
    </div>
  </p-dialog>

</div>
